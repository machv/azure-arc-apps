{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "1005818445430405198"
    }
  },
  "parameters": {
    "deployArcWebhook": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Whether to deploy Logic App with webhook triggered when Arc machine is created."
      }
    },
    "windowsServerLogicAppWebhookName": {
      "type": "string",
      "defaultValue": "la-arc-sa-windows-webhook"
    },
    "windowsServerLogicAppScheduledName": {
      "type": "string",
      "defaultValue": "la-arc-sa-windows-scheduled"
    },
    "sqlServerLogicAppScheduledName": {
      "type": "string",
      "defaultValue": "la-arc-sa-sql-scheduled"
    },
    "integrationAccountName": {
      "type": "string",
      "defaultValue": "ia-arc-logic",
      "metadata": {
        "description": "Only needed if webhook Logic Apps is being deployed."
      }
    },
    "subscriptionSystemTopicName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "If there is already a system topic created for subscription events, provide the name here to reuse it. If not provided, a new system topic will be created."
      }
    }
  },
  "variables": {
    "$fxv#0": "{\r\n    \"definition\": {\r\n        \"$schema\": \"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#\",\r\n        \"contentVersion\": \"1.0.0.0\",\r\n        \"triggers\": {\r\n            \"Recurrence\": {\r\n                \"recurrence\": {\r\n                    \"interval\": 1,\r\n                    \"frequency\": \"Day\",\r\n                    \"schedule\": {\r\n                        \"hours\": [\r\n                            2\r\n                        ],\r\n                        \"minutes\": [\r\n                            0\r\n                        ]\r\n                    }\r\n                },\r\n                \"evaluatedRecurrence\": {\r\n                    \"interval\": 1,\r\n                    \"frequency\": \"Day\",\r\n                    \"schedule\": {\r\n                        \"hours\": [\r\n                            2\r\n                        ],\r\n                        \"minutes\": [\r\n                            0\r\n                        ]\r\n                    }\r\n                },\r\n                \"type\": \"Recurrence\"\r\n            }\r\n        },\r\n        \"actions\": {\r\n            \"Get_Arc_machines_without_SA_benefits\": {\r\n                \"runAfter\": {},\r\n                \"type\": \"Http\",\r\n                \"inputs\": {\r\n                    \"uri\": \"https://management.azure.com/providers/Microsoft.ResourceGraph/resources?api-version=2022-10-01\",\r\n                    \"method\": \"POST\",\r\n                    \"headers\": {\r\n                        \"Content-Type\": \"application/json\"\r\n                    },\r\n                    \"body\": {\r\n                        \"query\": \"resources | where type =~ 'microsoft.hybridcompute/machines' | extend status = tostring(properties.status) | extend osType = tostring(properties.osType) | extend osEdition = tostring(properties.osEdition) | extend osSku = tostring(properties.osSku) | extend licenseStatus = tostring(properties.licenseProfile.licenseStatus) | extend licenseChannel = tostring(properties.licenseProfile.licenseChannel) | extend softwareAssurance = tostring(properties.licenseProfile.softwareAssurance.softwareAssuranceCustomer) | project id,name,status,location, resourceGroup, subscriptionId, osType, osEdition,osSku,licenseStatus, licenseChannel, softwareAssurance | where osType =~ 'windows' and licenseStatus =~ 'licensed' and softwareAssurance !~ 'true' and status =~ 'connected'\"\r\n                    },\r\n                    \"authentication\": {\r\n                        \"type\": \"ManagedServiceIdentity\",\r\n                        \"identity\": \"${MI_ID}\",\r\n                        \"audience\": \"\"\r\n                    }\r\n                },\r\n                \"runtimeConfiguration\": {\r\n                    \"contentTransfer\": {\r\n                        \"transferMode\": \"Chunked\"\r\n                    }\r\n                }\r\n            },\r\n            \"Parse_JSON\": {\r\n                \"runAfter\": {\r\n                    \"Get_Arc_machines_without_SA_benefits\": [\r\n                        \"Succeeded\"\r\n                    ]\r\n                },\r\n                \"type\": \"ParseJson\",\r\n                \"inputs\": {\r\n                    \"content\": \"@body('Get_Arc_machines_without_SA_benefits')\",\r\n                    \"schema\": {\r\n                        \"type\": \"object\",\r\n                        \"properties\": {\r\n                            \"totalRecords\": {\r\n                                \"type\": \"integer\"\r\n                            },\r\n                            \"count\": {\r\n                                \"type\": \"integer\"\r\n                            },\r\n                            \"data\": {\r\n                                \"type\": \"array\",\r\n                                \"items\": {\r\n                                    \"type\": \"object\",\r\n                                    \"properties\": {\r\n                                        \"id\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"name\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"location\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"resourceGroup\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"subscriptionId\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"osType\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"osEdition\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"osSku\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"licenseStatus\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"licenseChannel\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"softwareAssurance\": {\r\n                                            \"type\": \"string\"\r\n                                        }\r\n                                    },\r\n                                    \"required\": [\r\n                                        \"id\",\r\n                                        \"name\",\r\n                                        \"location\",\r\n                                        \"resourceGroup\",\r\n                                        \"subscriptionId\",\r\n                                        \"osType\",\r\n                                        \"osEdition\",\r\n                                        \"osSku\",\r\n                                        \"licenseStatus\",\r\n                                        \"licenseChannel\",\r\n                                        \"softwareAssurance\"\r\n                                    ]\r\n                                }\r\n                            },\r\n                            \"facets\": {\r\n                                \"type\": \"array\"\r\n                            },\r\n                            \"resultTruncated\": {\r\n                                \"type\": \"string\"\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            \"For_each\": {\r\n                \"foreach\": \"@body('Parse_JSON')?['data']\",\r\n                \"actions\": {\r\n                    \"Enable_SA_benefits\": {\r\n                        \"type\": \"Http\",\r\n                        \"inputs\": {\r\n                            \"uri\": \"https://management.azure.com@{item()?['id']}/licenseProfiles/default?api-version=2023-10-03-preview\",\r\n                            \"method\": \"PUT\",\r\n                            \"headers\": {\r\n                                \"Content-Type\": \"application/json\"\r\n                            },\r\n                            \"body\": {\r\n                                \"location\": \"@{item()?['location']}\",\r\n                                \"properties\": {\r\n                                    \"softwareAssurance\": {\r\n                                        \"softwareAssuranceCustomer\": true\r\n                                    }\r\n                                }\r\n                            },\r\n                            \"authentication\": {\r\n                                \"type\": \"ManagedServiceIdentity\",\r\n                                \"identity\": \"${MI_ID}\",\r\n                                \"audience\": \"\"\r\n                            }\r\n                        },\r\n                        \"runtimeConfiguration\": {\r\n                            \"contentTransfer\": {\r\n                                \"transferMode\": \"Chunked\"\r\n                            }\r\n                        }\r\n                    }\r\n                },\r\n                \"runAfter\": {\r\n                    \"Parse_JSON\": [\r\n                        \"Succeeded\"\r\n                    ]\r\n                },\r\n                \"type\": \"Foreach\"\r\n            }\r\n        },\r\n        \"outputs\": {},\r\n        \"parameters\": {\r\n            \"$connections\": {\r\n                \"type\": \"Object\",\r\n                \"defaultValue\": {}\r\n            }\r\n        }\r\n    },\r\n    \"parameters\": {\r\n        \"$connections\": {\r\n            \"type\": \"Object\",\r\n            \"value\": {}\r\n        }\r\n    }\r\n}",
    "$fxv#1": "{\r\n    \"definition\": {\r\n        \"$schema\": \"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#\",\r\n        \"contentVersion\": \"1.0.0.0\",\r\n        \"triggers\": {\r\n            \"Recurrence\": {\r\n                \"recurrence\": {\r\n                    \"interval\": 1,\r\n                    \"frequency\": \"Day\",\r\n                    \"schedule\": {\r\n                        \"hours\": [\r\n                            2\r\n                        ],\r\n                        \"minutes\": [\r\n                            0\r\n                        ]\r\n                    }\r\n                },\r\n                \"evaluatedRecurrence\": {\r\n                    \"interval\": 1,\r\n                    \"frequency\": \"Day\",\r\n                    \"schedule\": {\r\n                        \"hours\": [\r\n                            2\r\n                        ],\r\n                        \"minutes\": [\r\n                            0\r\n                        ]\r\n                    }\r\n                },\r\n                \"type\": \"Recurrence\"\r\n            }\r\n        },\r\n        \"actions\": {\r\n            \"Get_eligible_SQL_Servers_without_benefits\": {\r\n                \"runAfter\": {},\r\n                \"type\": \"Http\",\r\n                \"inputs\": {\r\n                    \"uri\": \"https://management.azure.com/providers/Microsoft.ResourceGraph/resources?api-version=2022-10-01\",\r\n                    \"method\": \"POST\",\r\n                    \"headers\": {\r\n                        \"Content-Type\": \"application/json\"\r\n                    },\r\n                    \"body\": {\r\n                        \"query\": \"resources | where type =~ 'microsoft.hybridcompute/machines' | extend status = tostring(properties.status) | project id, JoinID = toupper(id), status, subId=subscriptionId,resourceGroup,location | where status =~'Connected' | join kind=inner (       resources         | where type =~ 'microsoft.hybridcompute/machines/extensions' | where properties.type in ('WindowsAgent.SqlServer','LinuxAgent.SqlServer')         | extend ExtensionType = tostring(properties.type)         | extend LicenseType=tostring(iif(isnull( properties.settings.LicenseType),'NoLicense',properties.settings.LicenseType))         | extend pCoreLic = tostring(properties.settings.UsePhysicalCoreLicense.IsApplied)         | extend provisioningState =  tostring(properties.provisioningState)         | parse id with * '/providers/Microsoft.HybridCompute/machines/' machineName '/extensions/' *         | project MachineId = toupper(substring(id, 0, indexof(id, '/extensions'))), provisioningState, HostName=toupper(machineName),LicenseType,pCoreLic,ExtensionType         | where provisioningState =~'Succeeded'                 ) on $left.JoinID == $right.MachineId     |project id,status,    HostName,LicenseType,pCoreLic,subId,resourceGroup,location, ExtensionType | project  id,HostName, status, LicenseType,subId,resourceGroup,location, ExtensionType | where LicenseType in ('LicenseOnly','NoLicense')\"\r\n                    },\r\n                    \"authentication\": {\r\n                        \"type\": \"ManagedServiceIdentity\",\r\n                        \"identity\": \"${MI_ID}\",\r\n                        \"audience\": \"\"\r\n                    }\r\n                },\r\n                \"runtimeConfiguration\": {\r\n                    \"contentTransfer\": {\r\n                        \"transferMode\": \"Chunked\"\r\n                    }\r\n                }\r\n            },\r\n            \"Parse_JSON\": {\r\n                \"runAfter\": {\r\n                    \"Get_eligible_SQL_Servers_without_benefits\": [\r\n                        \"Succeeded\"\r\n                    ]\r\n                },\r\n                \"type\": \"ParseJson\",\r\n                \"inputs\": {\r\n                    \"content\": \"@body('Get_eligible_SQL_Servers_without_benefits')\",\r\n                    \"schema\": {\r\n                        \"type\": \"object\",\r\n                        \"properties\": {\r\n                            \"totalRecords\": {\r\n                                \"type\": \"integer\"\r\n                            },\r\n                            \"count\": {\r\n                                \"type\": \"integer\"\r\n                            },\r\n                            \"data\": {\r\n                                \"type\": \"array\",\r\n                                \"items\": {\r\n                                    \"type\": \"object\",\r\n                                    \"properties\": {\r\n                                        \"id\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"HostName\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"status\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"LicenseType\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"subId\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"resourceGroup\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"location\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"ExtensionType\": {\r\n                                            \"type\": \"string\"\r\n                                        }\r\n                                    },\r\n                                    \"required\": [\r\n                                        \"id\",\r\n                                        \"HostName\",\r\n                                        \"status\",\r\n                                        \"LicenseType\",\r\n                                        \"subId\",\r\n                                        \"resourceGroup\",\r\n                                        \"location\",\r\n                                        \"ExtensionType\"\r\n                                    ]\r\n                                }\r\n                            },\r\n                            \"facets\": {\r\n                                \"type\": \"array\"\r\n                            },\r\n                            \"resultTruncated\": {\r\n                                \"type\": \"string\"\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            \"For_each\": {\r\n                \"foreach\": \"@body('Parse_JSON')?['data']\",\r\n                \"actions\": {\r\n                    \"Set_license_type_to_Paid\": {\r\n                        \"type\": \"Http\",\r\n                        \"inputs\": {\r\n                            \"uri\": \"https://management.azure.com@{item()?['id']}/extensions/@{item()?['ExtensionType']}?api-version=2025-01-13\",\r\n                            \"method\": \"PUT\",\r\n                            \"body\": {\r\n                                \"location\": \"@{item()?['location']}\",\r\n                                \"properties\": {\r\n                                    \"publisher\": \"Microsoft.AzureData\",\r\n                                    \"type\": \"@{item()?['ExtensionType']}\",\r\n                                    \"settings\": {\r\n                                        \"LicenseType\": \"Paid\"\r\n                                    }\r\n                                }\r\n                            },\r\n                            \"authentication\": {\r\n                                \"type\": \"ManagedServiceIdentity\",\r\n                                \"identity\": \"${MI_ID}\",\r\n                                \"audience\": \"\"\r\n                            }\r\n                        },\r\n                        \"runtimeConfiguration\": {\r\n                            \"contentTransfer\": {\r\n                                \"transferMode\": \"Chunked\"\r\n                            }\r\n                        }\r\n                    }\r\n                },\r\n                \"runAfter\": {\r\n                    \"Parse_JSON\": [\r\n                        \"Succeeded\"\r\n                    ]\r\n                },\r\n                \"type\": \"Foreach\"\r\n            }\r\n        },\r\n        \"outputs\": {},\r\n        \"parameters\": {\r\n            \"$connections\": {\r\n                \"type\": \"Object\",\r\n                \"defaultValue\": {}\r\n            }\r\n        }\r\n    },\r\n    \"parameters\": {\r\n        \"$connections\": {\r\n            \"type\": \"Object\",\r\n            \"value\": {}\r\n        }\r\n    }\r\n}",
    "$fxv#2": "{\r\n    \"definition\": {\r\n        \"$schema\": \"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#\",\r\n        \"triggers\": {\r\n            \"When_a_resource_event_occurs\": {\r\n                \"type\": \"Request\",\r\n                \"kind\": \"Http\",\r\n                \"inputs\": {\r\n                    \"schema\": {\r\n                        \"type\": \"array\",\r\n                        \"items\": {\r\n                            \"type\": \"object\",\r\n                            \"properties\": {\r\n                                \"subject\": {\r\n                                    \"type\": \"string\"\r\n                                },\r\n                                \"eventType\": {\r\n                                    \"type\": \"string\"\r\n                                },\r\n                                \"id\": {\r\n                                    \"type\": \"string\"\r\n                                },\r\n                                \"data\": {\r\n                                    \"type\": \"object\",\r\n                                    \"properties\": {\r\n                                        \"authorization\": {\r\n                                            \"type\": \"object\",\r\n                                            \"properties\": {\r\n                                                \"scope\": {\r\n                                                    \"type\": \"string\"\r\n                                                },\r\n                                                \"action\": {\r\n                                                    \"type\": \"string\"\r\n                                                },\r\n                                                \"evidence\": {\r\n                                                    \"type\": \"object\",\r\n                                                    \"properties\": {\r\n                                                        \"role\": {\r\n                                                            \"type\": \"string\"\r\n                                                        },\r\n                                                        \"roleAssignmentScope\": {\r\n                                                            \"type\": \"string\"\r\n                                                        },\r\n                                                        \"roleAssignmentId\": {\r\n                                                            \"type\": \"string\"\r\n                                                        },\r\n                                                        \"roleDefinitionId\": {\r\n                                                            \"type\": \"string\"\r\n                                                        },\r\n                                                        \"principalId\": {\r\n                                                            \"type\": \"string\"\r\n                                                        },\r\n                                                        \"principalType\": {\r\n                                                            \"type\": \"string\"\r\n                                                        }\r\n                                                    }\r\n                                                }\r\n                                            }\r\n                                        },\r\n                                        \"correlationId\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"httpRequest\": {\r\n                                            \"type\": \"object\",\r\n                                            \"properties\": {\r\n                                                \"method\": {\r\n                                                    \"type\": \"string\"\r\n                                                },\r\n                                                \"url\": {\r\n                                                    \"type\": \"string\"\r\n                                                }\r\n                                            }\r\n                                        },\r\n                                        \"resourceProvider\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"resourceUri\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"operationName\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"status\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"subscriptionId\": {\r\n                                            \"type\": \"string\"\r\n                                        },\r\n                                        \"tenantId\": {\r\n                                            \"type\": \"string\"\r\n                                        }\r\n                                    }\r\n                                }\r\n                            },\r\n                            \"required\": [\r\n                                \"subject\",\r\n                                \"eventType\",\r\n                                \"id\",\r\n                                \"data\"\r\n                            ]\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        },\r\n        \"actions\": {\r\n            \"Verify_trigger_is_Arc_machine_resource\": {\r\n                \"runAfter\": {\r\n                    \"Get_first_resource\": [\r\n                        \"Succeeded\"\r\n                    ]\r\n                },\r\n                \"type\": \"JavaScriptCode\",\r\n                \"inputs\": {\r\n                    \"code\": \"var arcResourceIdPattern = \\\"^\\\\/subscriptions\\\\/[^\\\\/]+\\\\/resourceGroups\\\\/[^\\\\/]+\\\\/providers\\\\/Microsoft\\\\.HybridCompute\\\\/machines\\\\/[^\\\\/]+$\\\";\\r\\n\\r\\nvar subject = workflowContext.trigger.outputs.body[0].subject;\\r\\n\\r\\nreturn subject.match(arcResourceIdPattern) != null;\\r\\n\",\r\n                    \"explicitDependencies\": {\r\n                        \"actions\": []\r\n                    }\r\n                }\r\n            },\r\n            \"Get_first_resource\": {\r\n                \"runAfter\": {},\r\n                \"type\": \"InitializeVariable\",\r\n                \"inputs\": {\r\n                    \"variables\": [\r\n                        {\r\n                            \"name\": \"resource\",\r\n                            \"type\": \"object\",\r\n                            \"value\": \"@first(triggerBody())\"\r\n                        }\r\n                    ]\r\n                }\r\n            },\r\n            \"Is_Arc_Machine\": {\r\n                \"actions\": {\r\n                    \"Get_Arc_Machine_details\": {\r\n                        \"type\": \"Http\",\r\n                        \"inputs\": {\r\n                            \"uri\": \"https://management.azure.com@{variables('resource').subject}?api-version=2025-01-13\",\r\n                            \"method\": \"GET\",\r\n                            \"authentication\": {\r\n                                \"type\": \"ManagedServiceIdentity\",\r\n                                \"identity\": \"${MI_ID}\",\r\n                                \"audience\": \"\"\r\n                            }\r\n                        }\r\n                    },\r\n                    \"Is_Windows\": {\r\n                        \"actions\": {\r\n                            \"Enable_SA_Benefits\": {\r\n                                \"type\": \"Http\",\r\n                                \"inputs\": {\r\n                                    \"uri\": \"https://management.azure.com/@{body('Arc_Machine')?['id']}/licenseProfiles/default?api-version=2023-10-03-preview\",\r\n                                    \"method\": \"PUT\",\r\n                                    \"headers\": {\r\n                                        \"Content-Type\": \"application/json\"\r\n                                    },\r\n                                    \"body\": {\r\n                                        \"location\": \"@{body('Arc_Machine')?['location']}\",\r\n                                        \"properties\": {\r\n                                            \"softwareAssurance\": {\r\n                                                \"softwareAssuranceCustomer\": true\r\n                                            }\r\n                                        }\r\n                                    },\r\n                                    \"authentication\": {\r\n                                        \"type\": \"ManagedServiceIdentity\",\r\n                                        \"identity\": \"${MI_ID}\",\r\n                                        \"audience\": \"\"\r\n                                    }\r\n                                }\r\n                            }\r\n                        },\r\n                        \"runAfter\": {\r\n                            \"Arc_Machine\": [\r\n                                \"Succeeded\"\r\n                            ]\r\n                        },\r\n                        \"else\": {\r\n                            \"actions\": {\r\n                                \"Terminate_1\": {\r\n                                    \"type\": \"Terminate\",\r\n                                    \"inputs\": {\r\n                                        \"runStatus\": \"Cancelled\"\r\n                                    }\r\n                                }\r\n                            }\r\n                        },\r\n                        \"expression\": {\r\n                            \"and\": [\r\n                                {\r\n                                    \"equals\": [\r\n                                        \"@toLower(body('Arc_Machine')?['properties']?['osType'])\",\r\n                                        \"windows\"\r\n                                    ]\r\n                                }\r\n                            ]\r\n                        },\r\n                        \"type\": \"If\"\r\n                    },\r\n                    \"Arc_Machine\": {\r\n                        \"runAfter\": {\r\n                            \"Get_Arc_Machine_details\": [\r\n                                \"Succeeded\"\r\n                            ]\r\n                        },\r\n                        \"type\": \"ParseJson\",\r\n                        \"inputs\": {\r\n                            \"content\": \"@body('Get_Arc_Machine_details')\",\r\n                            \"schema\": {\r\n                                \"type\": \"object\",\r\n                                \"properties\": {\r\n                                    \"id\": {\r\n                                        \"type\": \"string\"\r\n                                    },\r\n                                    \"name\": {\r\n                                        \"type\": \"string\"\r\n                                    },\r\n                                    \"location\": {\r\n                                        \"type\": \"string\"\r\n                                    },\r\n                                    \"type\": {\r\n                                        \"type\": \"string\"\r\n                                    },\r\n                                    \"properties\": {\r\n                                        \"type\": \"object\",\r\n                                        \"properties\": {\r\n                                            \"provisioningState\": {\r\n                                                \"type\": \"string\"\r\n                                            },\r\n                                            \"status\": {\r\n                                                \"type\": \"string\"\r\n                                            },\r\n                                            \"lastStatusChange\": {\r\n                                                \"type\": \"string\"\r\n                                            },\r\n                                            \"displayName\": {\r\n                                                \"type\": \"string\"\r\n                                            },\r\n                                            \"machineFqdn\": {\r\n                                                \"type\": \"string\"\r\n                                            },\r\n                                            \"osName\": {\r\n                                                \"type\": \"string\"\r\n                                            },\r\n                                            \"osVersion\": {\r\n                                                \"type\": \"string\"\r\n                                            },\r\n                                            \"osType\": {\r\n                                                \"type\": \"string\"\r\n                                            },\r\n                                            \"osProfile\": {\r\n                                                \"type\": \"object\",\r\n                                                \"properties\": {\r\n                                                    \"computerName\": {\r\n                                                        \"type\": \"string\"\r\n                                                    }\r\n                                                }\r\n                                            },\r\n                                            \"osSku\": {\r\n                                                \"type\": \"string\"\r\n                                            },\r\n                                            \"osEdition\": {\r\n                                                \"type\": \"string\"\r\n                                            },\r\n                                            \"osInstallDate\": {\r\n                                                \"type\": \"string\"\r\n                                            },\r\n                                            \"domainName\": {\r\n                                                \"type\": \"string\"\r\n                                            },\r\n                                            \"adFqdn\": {\r\n                                                \"type\": \"string\"\r\n                                            },\r\n                                            \"dnsFqdn\": {\r\n                                                \"type\": \"string\"\r\n                                            },\r\n                                            \"mssqlDiscovered\": {\r\n                                                \"type\": \"string\"\r\n                                            },\r\n                                            \"licenseProfile\": {\r\n                                                \"type\": \"object\",\r\n                                                \"properties\": {\r\n                                                    \"licenseStatus\": {\r\n                                                        \"type\": \"string\"\r\n                                                    },\r\n                                                    \"licenseChannel\": {\r\n                                                        \"type\": \"string\"\r\n                                                    },\r\n                                                    \"esuProfile\": {\r\n                                                        \"type\": \"object\",\r\n                                                        \"properties\": {\r\n                                                            \"licenseAssignmentState\": {\r\n                                                                \"type\": \"string\"\r\n                                                            },\r\n                                                            \"serverType\": {\r\n                                                                \"type\": \"string\"\r\n                                                            },\r\n                                                            \"esuEligibility\": {\r\n                                                                \"type\": \"string\"\r\n                                                            },\r\n                                                            \"esuKeyState\": {\r\n                                                                \"type\": \"string\"\r\n                                                            }\r\n                                                        }\r\n                                                    }\r\n                                                }\r\n                                            }\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                },\r\n                \"runAfter\": {\r\n                    \"Verify_trigger_is_Arc_machine_resource\": [\r\n                        \"Succeeded\"\r\n                    ]\r\n                },\r\n                \"else\": {\r\n                    \"actions\": {\r\n                        \"Terminate\": {\r\n                            \"type\": \"Terminate\",\r\n                            \"inputs\": {\r\n                                \"runStatus\": \"Cancelled\"\r\n                            }\r\n                        }\r\n                    }\r\n                },\r\n                \"expression\": {\r\n                    \"and\": [\r\n                        {\r\n                            \"equals\": [\r\n                                \"@body('Verify_trigger_is_Arc_machine_resource')\",\r\n                                \"@true\"\r\n                            ]\r\n                        }\r\n                    ]\r\n                },\r\n                \"type\": \"If\"\r\n            }\r\n        },\r\n        \"parameters\": {\r\n            \"$connections\": {\r\n                \"type\": \"Object\",\r\n                \"defaultValue\": {}\r\n            }\r\n        }\r\n    },\r\n    \"parameters\": {\r\n        \"$connections\": {\r\n            \"type\": \"Object\",\r\n            \"value\": {}\r\n        }\r\n    }\r\n}",
    "location": "[resourceGroup().location]",
    "subscriptionId": "[subscription().subscriptionId]",
    "useExistingSystemTopic": "[not(equals(parameters('subscriptionSystemTopicName'), ''))]",
    "systemTopicName": "[if(not(equals(parameters('subscriptionSystemTopicName'), '')), parameters('subscriptionSystemTopicName'), format('st-subscription-{0}', variables('subscriptionId')))]",
    "systemTopicRef": "[if(variables('useExistingSystemTopic'), variables('systemTopicName'), variables('systemTopicName'))]",
    "azureConnectedMachineResourceAdminRoleId": "cd570a14-e51a-42ad-bac8-bafd67325302"
  },
  "resources": [
    {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2018-11-30",
      "name": "mi-arc-logicapps",
      "location": "[variables('location')]"
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('windowsServerLogicAppScheduledName')]",
      "location": "[variables('location')]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'mi-arc-logicapps'))]": {}
        }
      },
      "properties": {
        "definition": "[json(replace(variables('$fxv#0'), '${MI_ID}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'mi-arc-logicapps'))).definition]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'mi-arc-logicapps')]"
      ]
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('sqlServerLogicAppScheduledName')]",
      "location": "[variables('location')]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'mi-arc-logicapps'))]": {}
        }
      },
      "properties": {
        "definition": "[json(replace(variables('$fxv#1'), '${MI_ID}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'mi-arc-logicapps'))).definition]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'mi-arc-logicapps')]"
      ]
    },
    {
      "condition": "[parameters('deployArcWebhook')]",
      "type": "Microsoft.Logic/integrationAccounts",
      "apiVersion": "2019-05-01",
      "name": "[parameters('integrationAccountName')]",
      "location": "[variables('location')]",
      "sku": {
        "name": "Free"
      },
      "properties": {}
    },
    {
      "condition": "[parameters('deployArcWebhook')]",
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('windowsServerLogicAppWebhookName')]",
      "location": "[variables('location')]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'mi-arc-logicapps'))]": {}
        }
      },
      "properties": {
        "integrationAccount": {
          "id": "[resourceId('Microsoft.Logic/integrationAccounts', parameters('integrationAccountName'))]"
        },
        "definition": "[json(replace(variables('$fxv#2'), '${MI_ID}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'mi-arc-logicapps'))).definition]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Logic/integrationAccounts', parameters('integrationAccountName'))]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'mi-arc-logicapps')]"
      ]
    },
    {
      "condition": "[and(parameters('deployArcWebhook'), not(variables('useExistingSystemTopic')))]",
      "type": "Microsoft.EventGrid/systemTopics",
      "apiVersion": "2021-12-01",
      "name": "[variables('systemTopicName')]",
      "location": "global",
      "properties": {
        "source": "[format('/subscriptions/{0}', variables('subscriptionId'))]",
        "topicType": "Microsoft.Resources.Subscriptions"
      }
    },
    {
      "condition": "[parameters('deployArcWebhook')]",
      "type": "Microsoft.EventGrid/systemTopics/eventSubscriptions",
      "apiVersion": "2021-12-01",
      "name": "[format('{0}/sub-arc-machines-creation-{1}', variables('systemTopicRef'), variables('subscriptionId'))]",
      "properties": {
        "destination": {
          "endpointType": "WebHook",
          "properties": {
            "endpointUrl": "[listCallbackUrl(format('{0}/triggers/When_a_resource_event_occurs', resourceId('Microsoft.Logic/workflows', parameters('windowsServerLogicAppWebhookName'))), '2016-06-01').value]"
          }
        },
        "filter": {
          "includedEventTypes": [
            "Microsoft.Resources.ResourceWriteSuccess"
          ],
          "advancedFilters": [
            {
              "operatorType": "StringContains",
              "key": "data.resourceUri",
              "values": [
                "providers/Microsoft.HybridCompute/machines"
              ]
            },
            {
              "operatorType": "StringIn",
              "key": "data.operationName",
              "values": [
                "Microsoft.HybridCompute/machines/write"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.EventGrid/systemTopics', variables('systemTopicName'))]",
        "[resourceId('Microsoft.Logic/workflows', parameters('windowsServerLogicAppWebhookName'))]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(resourceGroup().id, resourceId('Microsoft.Logic/workflows', parameters('windowsServerLogicAppWebhookName')), variables('azureConnectedMachineResourceAdminRoleId'))]",
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('azureConnectedMachineResourceAdminRoleId'))]",
        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'mi-arc-logicapps'), '2018-11-30').principalId]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'mi-arc-logicapps')]",
        "[resourceId('Microsoft.Logic/workflows', parameters('windowsServerLogicAppWebhookName'))]"
      ]
    }
  ]
}